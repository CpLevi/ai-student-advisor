<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Student Advisor v3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
<style>
:root {
  --primary: #8b5cf6;
  --primary-dark: #7c3aed;
  --secondary: #06b6d4;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --glass-bg: rgba(255,255,255,0.8);
  --glass-border: rgba(139,92,246,0.2);
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --message-bot-bg: rgba(248,250,252,0.95);
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
  --bg-gradient: linear-gradient(135deg, #f5f3ff 0%, #ecfeff 100%);
}

[data-theme="dark"] {
  --primary: #a78bfa;
  --primary-dark: #8b5cf6;
  --secondary: #22d3ee;
  --glass-bg: rgba(17,24,39,0.9);
  --glass-border: rgba(167,139,250,0.3);
  --text-primary: #f9fafb;
  --text-secondary: #9ca3af;
  --message-bot-bg: rgba(31,41,55,0.95);
  --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  min-height: 100vh;
  background: var(--bg-gradient);
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: "Inter", sans-serif;
  padding: 16px;
  transition: background 0.3s ease;
}

.chat-container {
  width: 100%;
  max-width: 900px;
  height: 95vh;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  display: grid;
  grid-template-rows: auto 1fr auto auto;
  border-radius: 24px;
  box-shadow: var(--shadow-lg), 0 0 0 1px var(--glass-border);
  overflow: hidden;
  transition: all 0.3s ease;
}

/* HEADER */
.header {
  padding: 16px 20px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

.header-left, .header-right {
  display: flex;
  gap: 8px;
  z-index: 2;
}

.icon-btn {
  width: 38px;
  height: 38px;
  border-radius: 12px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.2s;
  position: relative;
}

.icon-btn:hover {
  background: rgba(255,255,255,0.25);
  transform: translateY(-2px);
}

.icon-btn:active {
  transform: translateY(0);
}

.badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger);
  color: white;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 10px;
  min-width: 16px;
  text-align: center;
}

.header-center {
  flex: 1;
  text-align: center;
}

.header-center h1 {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 4px;
  letter-spacing: -0.5px;
}

.header-center p {
  font-size: 12px;
  opacity: 0.95;
  font-weight: 500;
}

.status-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  margin-right: 6px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* MESSAGES */
.messages {
  padding: 20px;
  overflow-y: auto;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.messages::-webkit-scrollbar {
  width: 6px;
}

.messages::-webkit-scrollbar-track {
  background: transparent;
}

.messages::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 10px;
}

.message-wrapper {
  display: flex;
  gap: 12px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.user {
  flex-direction: row-reverse;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  font-weight: 700;
}

.message-wrapper.user .avatar {
  background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
}

.message {
  max-width: 75%;
  padding: 14px 18px;
  border-radius: 16px;
  line-height: 1.6;
  font-size: 14px;
  position: relative;
  color: var(--text-primary);
}

.message-wrapper.user .message {
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
  color: white;
  border-bottom-right-radius: 4px;
  box-shadow: var(--shadow);
}

.message-wrapper.bot .message {
  background: var(--message-bot-bg);
  border-bottom-left-radius: 4px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
}

.message strong {
  color: var(--primary);
  font-weight: 700;
}

.message-wrapper.user .message strong {
  color: rgba(255,255,255,0.95);
}

.message ul {
  margin: 12px 0;
  padding-left: 0;
  list-style: none;
}

.message li {
  margin: 8px 0;
  padding-left: 24px;
  position: relative;
}

.message li::before {
  content: "‚Üí";
  position: absolute;
  left: 0;
  color: var(--secondary);
  font-weight: 700;
}

.message code {
  background: rgba(139,92,246,0.1);
  padding: 2px 8px;
  border-radius: 6px;
  font-size: 13px;
  color: var(--primary-dark);
  font-family: 'Courier New', monospace;
}

.message pre {
  background: rgba(139,92,246,0.05);
  padding: 16px;
  border-radius: 12px;
  overflow-x: auto;
  margin: 12px 0;
  border: 1px solid var(--glass-border);
}

.message-actions {
  display: flex;
  gap: 6px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--glass-border);
}

.action-btn {
  padding: 6px 12px;
  border-radius: 8px;
  background: rgba(139,92,246,0.1);
  border: 1px solid rgba(139,92,246,0.2);
  color: var(--primary);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}

.action-btn:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-1px);
}

.timestamp {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 6px;
  opacity: 0.7;
}

/* SUGGESTIONS */
.suggestions {
  display: flex;
  gap: 8px;
  padding: 0 20px 16px;
  overflow-x: auto;
  scrollbar-width: none;
}

.suggestions::-webkit-scrollbar {
  display: none;
}

.suggestion-chip {
  padding: 10px 16px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  flex-shrink: 0;
}

.suggestion-chip:hover {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
  transform: translateY(-2px);
}

/* INPUT */
.input-container {
  padding: 20px;
  background: var(--glass-bg);
  border-top: 1px solid var(--glass-border);
}

.feature-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  overflow-x: auto;
  scrollbar-width: none;
  padding-bottom: 4px;
}

.feature-tabs::-webkit-scrollbar {
  display: none;
}

.tab-btn {
  padding: 8px 16px;
  background: rgba(139,92,246,0.1);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  flex-shrink: 0;
}

.tab-btn:hover {
  background: rgba(139,92,246,0.15);
}

.tab-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.input-wrapper {
  display: flex;
  gap: 10px;
  background: white;
  backdrop-filter: blur(30px);
  border-radius: 16px;
  padding: 8px;
  border: 2px solid var(--glass-border);
  transition: all 0.3s;
}

[data-theme="dark"] .input-wrapper {
  background: rgba(31,41,55,0.9);
}

.input-wrapper.focused {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(139,92,246,0.1);
}

.input-wrapper input[type="text"] {
  flex: 1;
  padding: 12px;
  border: none;
  outline: none;
  font-size: 14px;
  background: transparent;
  color: var(--text-primary);
  font-family: inherit;
  font-weight: 500;
}

.input-wrapper input[type="text"]::placeholder {
  color: var(--text-secondary);
}

.input-btn {
  padding: 10px 16px;
  border-radius: 12px;
  border: none;
  background: rgba(139,92,246,0.1);
  color: var(--primary);
  cursor: pointer;
  font-weight: 700;
  font-size: 13px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.input-btn:hover {
  background: rgba(139,92,246,0.2);
}

.input-btn.primary {
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
  color: white;
}

.input-btn.primary:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.input-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.char-counter {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
  text-align: right;
}

/* TYPING INDICATOR */
.typing-indicator {
  display: flex;
  gap: 8px;
  padding: 14px 18px;
  background: var(--message-bot-bg);
  border-radius: 16px;
  border-bottom-left-radius: 4px;
  max-width: fit-content;
  border: 1px solid var(--glass-border);
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--primary);
  animation: bounce 1.4s ease-in-out infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-10px); }
}

/* MODALS */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--glass-bg);
  backdrop-filter: blur(40px);
  border-radius: 20px;
  padding: 28px;
  max-width: 600px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--glass-border);
  animation: modalSlide 0.3s ease;
}

@keyframes modalSlide {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--glass-border);
}

.modal-header h2 {
  font-size: 22px;
  color: var(--text-primary);
  font-weight: 800;
}

.close-btn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.2);
  color: var(--danger);
  cursor: pointer;
  font-size: 20px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: var(--danger);
  color: white;
}

.history-item {
  padding: 16px;
  margin-bottom: 12px;
  background: rgba(139,92,246,0.05);
  border-radius: 14px;
  border: 1px solid var(--glass-border);
  cursor: pointer;
  transition: all 0.2s;
}

.history-item:hover {
  background: rgba(139,92,246,0.1);
  transform: translateX(4px);
  box-shadow: var(--shadow);
}

.history-item-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.history-item-meta {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.delete-btn {
  padding: 6px 12px;
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: 8px;
  color: var(--danger);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.delete-btn:hover {
  background: var(--danger);
  color: white;
}

/* TOAST */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 16px 24px;
  background: var(--primary);
  color: white;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: var(--shadow-lg);
  z-index: 2000;
  display: flex;
  align-items: center;
  gap: 10px;
  animation: toastSlide 0.3s ease, toastSlideOut 0.3s ease 2.7s forwards;
}

@keyframes toastSlide {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes toastSlideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 14px;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .chat-container {
    height: 100vh;
    border-radius: 0;
    max-width: 100%;
  }
  
  body {
    padding: 0;
  }
  
  .message {
    max-width: 85%;
  }
  
  .header-center h1 {
    font-size: 16px;
  }
  
  .header-center p {
    font-size: 10px;
  }
}

/* FILE PREVIEW */
.file-preview {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: rgba(139,92,246,0.1);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  margin-bottom: 12px;
}

.file-preview-icon {
  font-size: 24px;
}

.file-preview-info {
  flex: 1;
}

.file-preview-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.file-preview-size {
  font-size: 11px;
  color: var(--text-secondary);
}

.file-preview-remove {
  padding: 6px 10px;
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: 8px;
  color: var(--danger);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}

.file-preview-remove:hover {
  background: var(--danger);
  color: white;
}
</style>
</head>
<body data-theme="light">

<div class="chat-container">
  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <button class="icon-btn" id="historyBtn" title="Chat History">
        üìö
        <span class="badge" id="historyBadge" style="display: none;">0</span>
      </button>
      <button class="icon-btn" id="themeBtn" title="Toggle Theme">üåô</button>
    </div>
    <div class="header-center">
      <h1>‚ú® AI Student Advisor v3.0</h1>
      <p><span class="status-indicator"></span>Smart ‚Ä¢ Fast ‚Ä¢ Helpful</p>
    </div>
    <div class="header-right">
      <button class="icon-btn" id="exportBtn" title="Export Chat">üíæ</button>
      <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <button class="icon-btn" id="clearBtn" title="Clear Chat">üóëÔ∏è</button>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="messages" id="messages">
    <div class="message-wrapper bot">
      <div class="avatar">ü§ñ</div>
      <div>
        <div class="message">
          <strong>üëã Welcome to AI Student Advisor v3.0!</strong><br><br>
          I'm here to help you with:<br>
          ‚Üí <strong>Study Tips</strong> - Effective learning strategies<br>
          ‚Üí <strong>Career Guidance</strong> - AI, Data Science, Tech careers<br>
          ‚Üí <strong>Concept Explanations</strong> - ML, AI, Programming<br>
          ‚Üí <strong>Project Ideas</strong> - Portfolio-worthy projects<br>
          ‚Üí <strong>Resume Review</strong> - Professional feedback<br><br>
          Try the quick suggestions below or ask me anything! üöÄ
        </div>
        <div class="timestamp" id="welcomeTime"></div>
      </div>
    </div>
  </div>

  <!-- SUGGESTIONS -->
  <div class="suggestions" id="suggestions">
    <div class="suggestion-chip" data-text="Explain machine learning in simple terms">üß† What is ML?</div>
    <div class="suggestion-chip" data-text="AI vs Data Science - which career?">üíº AI vs DS Career</div>
    <div class="suggestion-chip" data-text="Best way to prepare for exams">üìö Study Tips</div>
    <div class="suggestion-chip" data-text="Python project ideas for beginners">üêç Python Projects</div>
    <div class="suggestion-chip" data-text="Skills needed for AI jobs">üéØ AI Skills</div>
  </div>

  <!-- INPUT -->
  <div class="input-container">
    <div class="feature-tabs">
      <button class="tab-btn active" data-mode="chat">üí¨ Chat</button>
      <button class="tab-btn" data-mode="image">üì∏ Image</button>
      <button class="tab-btn" data-mode="resume">üìÑ Resume</button>
      <button class="tab-btn" data-mode="quiz">üìù Quiz</button>
    </div>
    
    <div id="filePreviewContainer"></div>
    
    <div class="input-wrapper" id="inputWrapper">
      <input type="file" id="fileInput" style="display:none" accept="image/*,.pdf,.txt,.doc,.docx"/>
      
      <button class="input-btn" id="attachBtn" style="display:none" title="Attach File">
        üìé
      </button>
      
      <input type="text" id="userInput" placeholder="Ask anything about studies, career, or tech..." maxlength="2000"/>
      
      <button class="input-btn" id="voiceBtn" title="Voice Input">
        üé§
      </button>
      
      <button class="input-btn primary" id="sendBtn">
        Send ‚úàÔ∏è
      </button>
    </div>
    
    <div class="char-counter" id="charCounter">0 / 2000</div>
  </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal" id="historyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìö Chat History</h2>
      <button class="close-btn" id="closeHistoryBtn">‚úï</button>
    </div>
    <div id="historyList">
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No History Yet</h3>
        <p>Your conversations will appear here</p>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚öôÔ∏è Settings</h2>
      <button class="close-btn" id="closeSettingsBtn">‚úï</button>
    </div>
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div style="padding: 16px; background: rgba(139,92,246,0.05); border-radius: 12px; border: 1px solid var(--glass-border);">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
          <span style="font-weight: 600; color: var(--text-primary);">üîî Sound Effects</span>
          <input type="checkbox" id="soundToggle" checked style="width: 20px; height: 20px; cursor: pointer;">
        </label>
      </div>
      
      <div style="padding: 16px; background: rgba(139,92,246,0.05); border-radius: 12px; border: 1px solid var(--glass-border);">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
          <span style="font-weight: 600; color: var(--text-primary);">‚è±Ô∏è Show Timestamps</span>
          <input type="checkbox" id="timestampToggle" checked style="width: 20px; height: 20px; cursor: pointer;">
        </label>
      </div>
      
      <div style="padding: 16px; background: rgba(139,92,246,0.05); border-radius: 12px; border: 1px solid var(--glass-border);">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
          <span style="font-weight: 600; color: var(--text-primary);">üí° Show Suggestions</span>
          <input type="checkbox" id="suggestionsToggle" checked style="width: 20px; height: 20px; cursor: pointer;">
        </label>
      </div>
      
      <button class="input-btn primary" style="width: 100%; justify-content: center;" id="clearAllDataBtn">
        üóëÔ∏è Clear All Data
      </button>
    </div>
  </div>
</div>

<script>
// Global variables
const messagesDiv = document.getElementById("messages");
const inputEl = document.getElementById("userInput");
const inputWrapper = document.getElementById("inputWrapper");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");
const attachBtn = document.getElementById("attachBtn");
const voiceBtn = document.getElementById("voiceBtn");
const suggestionsDiv = document.getElementById("suggestions");
const charCounter = document.getElementById("charCounter");
const sessionId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();

let currentMode = 'chat';
let selectedFile = null;
let settings = {
  sound: true,
  timestamps: true,
  suggestions: true
};

// Initialize
function init() {
  loadTheme();
  loadSettings();
  initEventListeners();
  updateHistoryBadge();
  updateWelcomeTime();
  inputEl.focus();
}

function initEventListeners() {
  // Header buttons
  document.getElementById('historyBtn').addEventListener('click', toggleHistory);
  document.getElementById('themeBtn').addEventListener('click', toggleTheme);
  document.getElementById('exportBtn').addEventListener('click', exportChat);
  document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
  document.getElementById('clearBtn').addEventListener('click', clearChat);
  
  // Input
  sendBtn.addEventListener('click', () => sendMessage());
  inputEl.addEventListener('input', updateCharCounter);
  inputEl.addEventListener('focus', () => inputWrapper.classList.add('focused'));
  inputEl.addEventListener('blur', () => inputWrapper.classList.remove('focused'));
  inputEl.addEventListener('keypress', handleKeyPress);
  
  // File
  attachBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', handleFileSelect);
  
  // Voice
  voiceBtn.addEventListener('click', handleVoiceInput);
  
  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      setMode(this.getAttribute('data-mode'));
    });
  });
  
  // Suggestions
  document.querySelectorAll('.suggestion-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      const text = this.getAttribute('data-text');
      inputEl.value = text;
      sendMessage();
    });
  });
  
  // Modals
  document.getElementById('closeHistoryBtn').addEventListener('click', toggleHistory);
  document.getElementById('closeSettingsBtn').addEventListener('click', toggleSettings);
  document.getElementById('historyModal').addEventListener('click', function(e) {
    if (e.target === this) toggleHistory();
  });
  document.getElementById('settingsModal').addEventListener('click', function(e) {
    if (e.target === this) toggleSettings();
  });
  
  // Settings
  document.getElementById('soundToggle').addEventListener('change', function() {
    settings.sound = this.checked;
    saveSettings();
  });
  document.getElementById('timestampToggle').addEventListener('change', function() {
    settings.timestamps = this.checked;
    saveSettings();
    updateTimestampDisplay();
  });
  document.getElementById('suggestionsToggle').addEventListener('change', function() {
    settings.suggestions = this.checked;
    saveSettings();
    suggestionsDiv.style.display = this.checked ? 'flex' : 'none';
  });
  document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);
  
  // Message actions (delegation)
  messagesDiv.addEventListener('click', function(e) {
    if (e.target.closest('.action-btn')) {
      const btn = e.target.closest('.action-btn');
      const action = btn.textContent.trim();
      if (action.includes('üìã') || action.includes('‚úÖ')) copyMessage(btn);
      else if (action.includes('üîÑ') || action.includes('‚è≥')) regenerateMessage(btn);
      else if (action.includes('üîä') || action.includes('‚è∏Ô∏è')) speakMessage(btn);
    }
  });
  
  // Global keyboard shortcuts
  document.addEventListener('keydown', handleGlobalShortcuts);
  
  // Prevent accidental page close
  window.addEventListener('beforeunload', function(e) {
    const hasMessages = messagesDiv.querySelectorAll('.message-wrapper').length > 1;
    if (hasMessages) {
      e.preventDefault();
      e.returnValue = 'You have an active conversation. Are you sure you want to leave?';
    }
  });
}

// Global keyboard shortcuts
function handleGlobalShortcuts(e) {
  // Ctrl/Cmd + K - Focus input
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    inputEl.focus();
    inputEl.select();
  }
  
  // Ctrl/Cmd + H - Toggle history
  if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
    e.preventDefault();
    toggleHistory();
  }
  
  // Ctrl/Cmd + , - Toggle settings
  if ((e.ctrlKey || e.metaKey) && e.key === ',') {
    e.preventDefault();
    toggleSettings();
  }
  
  // Ctrl/Cmd + E - Export chat
  if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
    e.preventDefault();
    exportChat();
  }
  
  // Ctrl/Cmd + L - Clear chat
  if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
    e.preventDefault();
    clearChat();
  }
  
  // Ctrl/Cmd + D - Toggle dark mode
  if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
    e.preventDefault();
    toggleTheme();
  }
  
  // Escape - Close modals or stop speech/listening
  if (e.key === 'Escape') {
    const historyModal = document.getElementById('historyModal');
    const settingsModal = document.getElementById('settingsModal');
    
    if (historyModal.classList.contains('active')) {
      toggleHistory();
    } else if (settingsModal.classList.contains('active')) {
      toggleSettings();
    } else if (isSpeaking) {
      speechSynthesis.cancel();
      isSpeaking = false;
    } else if (isListening && recognition) {
      recognition.stop();
      isListening = false;
    }
  }
}

// Theme
function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  document.getElementById('themeBtn').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  showToast(newTheme === 'dark' ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode');
  playSound('click');
}

function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.setAttribute('data-theme', savedTheme);
  document.getElementById('themeBtn').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

// Settings
function loadSettings() {
  const saved = localStorage.getItem('settings');
  if (saved) {
    settings = JSON.parse(saved);
    document.getElementById('soundToggle').checked = settings.sound;
    document.getElementById('timestampToggle').checked = settings.timestamps;
    document.getElementById('suggestionsToggle').checked = settings.suggestions;
    suggestionsDiv.style.display = settings.suggestions ? 'flex' : 'none';
  }
}

function saveSettings() {
  localStorage.setItem('settings', JSON.stringify(settings));
}

function toggleSettings() {
  const modal = document.getElementById('settingsModal');
  modal.classList.toggle('active');
}

// Mode
function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
  
  if (mode === 'image' || mode === 'resume') {
    attachBtn.style.display = 'flex';
    inputEl.placeholder = mode === 'image' 
      ? 'Describe what to analyze in the image...' 
      : 'Target role (e.g., Software Engineer, Data Scientist)...';
  } else {
    attachBtn.style.display = 'none';
    selectedFile = null;
    clearFilePreview();
    inputEl.placeholder = mode === 'quiz' 
      ? 'Enter quiz topic (e.g., Python basics, Machine Learning)...' 
      : 'Ask anything about studies, career, or tech...';
  }
  
  showToast(`${getModeIcon(mode)} ${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode`);
  playSound('click');
}

function getModeIcon(mode) {
  const icons = { chat: 'üí¨', image: 'üì∏', resume: 'üìÑ', quiz: 'üìù' };
  return icons[mode] || 'üí¨';
}

// File handling
function handleFileSelect(event) {
  selectedFile = event.target.files[0];
  if (selectedFile) {
    // Validate file size (10MB limit)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (selectedFile.size > maxSize) {
      showToast('‚ùå File too large (max 10MB)');
      selectedFile = null;
      fileInput.value = '';
      playSound('error');
      return;
    }
    
    // Validate file type
    const validTypes = {
      'image': ['jpg', 'jpeg', 'png', 'gif', 'webp'],
      'resume': ['pdf', 'txt', 'doc', 'docx']
    };
    
    const ext = selectedFile.name.split('.').pop().toLowerCase();
    const isValidImage = validTypes.image.includes(ext);
    const isValidResume = validTypes.resume.includes(ext);
    
    if (currentMode === 'image' && !isValidImage) {
      showToast('‚ùå Please upload an image file');
      selectedFile = null;
      fileInput.value = '';
      playSound('error');
      return;
    }
    
    if (currentMode === 'resume' && !isValidResume) {
      showToast('‚ùå Please upload PDF, TXT, DOC, or DOCX');
      selectedFile = null;
      fileInput.value = '';
      playSound('error');
      return;
    }
    
    showFilePreview();
    showToast(`‚úÖ ${selectedFile.name} attached`);
    playSound('success');
  }
}

function showFilePreview() {
  const container = document.getElementById('filePreviewContainer');
  const sizeKB = (selectedFile.size / 1024).toFixed(1);
  container.innerHTML = `
    <div class="file-preview">
      <div class="file-preview-icon">${getFileIcon(selectedFile.name)}</div>
      <div class="file-preview-info">
        <div class="file-preview-name">${selectedFile.name}</div>
        <div class="file-preview-size">${sizeKB} KB</div>
      </div>
      <button class="file-preview-remove" onclick="clearFilePreview()">Remove</button>
    </div>
  `;
}

function clearFilePreview() {
  document.getElementById('filePreviewContainer').innerHTML = '';
  selectedFile = null;
  fileInput.value = '';
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    'pdf': 'üìï',
    'doc': 'üìò', 'docx': 'üìò',
    'txt': 'üìÑ',
    'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è'
  };
  return icons[ext] || 'üìé';
}

// Voice input with better feedback
let recognition = null;
let isListening = false;

function handleVoiceInput() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    showToast('‚ùå Voice input not supported in your browser');
    return;
  }

  // Stop listening if already active
  if (isListening && recognition) {
    recognition.stop();
    isListening = false;
    voiceBtn.textContent = 'üé§';
    voiceBtn.style.background = 'rgba(139,92,246,0.1)';
    showToast('‚è∏Ô∏è Stopped listening');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    isListening = true;
    voiceBtn.textContent = '‚è∫Ô∏è';
    voiceBtn.style.background = 'var(--danger)';
    voiceBtn.style.color = 'white';
    showToast('üé§ Listening... (speak now)');
    playSound('success');
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    inputEl.value = transcript;
    updateCharCounter();
    showToast('‚úÖ Voice recognized');
    playSound('success');
  };

  recognition.onerror = (event) => {
    isListening = false;
    voiceBtn.textContent = 'üé§';
    voiceBtn.style.background = 'rgba(139,92,246,0.1)';
    voiceBtn.style.color = 'var(--primary)';
    
    if (event.error === 'no-speech') {
      showToast('‚ùå No speech detected');
    } else if (event.error === 'not-allowed') {
      showToast('‚ùå Microphone permission denied');
    } else {
      showToast('‚ùå Voice input failed');
    }
    playSound('error');
  };

  recognition.onend = () => {
    isListening = false;
    voiceBtn.textContent = 'üé§';
    voiceBtn.style.background = 'rgba(139,92,246,0.1)';
    voiceBtn.style.color = 'var(--primary)';
  };

  recognition.start();
}

// Character counter
function updateCharCounter() {
  const count = inputEl.value.length;
  charCounter.textContent = `${count} / 2000`;
  charCounter.style.color = count > 1800 ? 'var(--danger)' : 'var(--text-secondary)';
}

function handleKeyPress(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// Messages
function formatMarkdown(text) {
  text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, (m, lang, code) => {
    const highlighted = lang && hljs.getLanguage(lang) 
      ? hljs.highlight(code.trim(), {language: lang}).value 
      : hljs.highlightAuto(code.trim()).value;
    return `<pre><code class="hljs">${highlighted}</code></pre>`;
  });
  
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/^[‚Üí‚Ä¢\-\*]\s+(.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>.*?<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
  text = text.replace(/\n\n+/g, '</p><p>');
  if (!text.startsWith('<')) text = '<p>' + text + '</p>';
  text = text.replace(/\n/g, '<br>');
  
  return text;
}

function getMessageActions() {
  return `<div class="message-actions">
    <button class="action-btn">üìã Copy</button>
    <button class="action-btn">üîÑ Regen</button>
    <button class="action-btn">üîä Speak</button>
  </div>`;
}

function getAvatar(role) {
  return role === 'user' ? 'üë§' : 'ü§ñ';
}

function getCurrentTime() {
  return new Date().toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
}

function updateWelcomeTime() {
  const welcomeTime = document.getElementById('welcomeTime');
  if (welcomeTime && settings.timestamps) {
    welcomeTime.textContent = getCurrentTime();
  }
}

function updateTimestampDisplay() {
  document.querySelectorAll('.timestamp').forEach(ts => {
    ts.style.display = settings.timestamps ? 'block' : 'none';
  });
}

async function sendMessage(customMsg) {
  const message = customMsg || inputEl.value.trim();
  if (!message && !selectedFile) {
    inputEl.focus();
    inputEl.style.borderColor = 'var(--danger)';
    setTimeout(() => inputEl.style.borderColor = '', 500);
    showToast('‚ö†Ô∏è Please type a message');
    return;
  }
  
  // Disable send button to prevent double-sending
  sendBtn.disabled = true;
  sendBtn.textContent = '‚è≥';
  playSound('send');
  
  // Stop any ongoing speech
  if (isSpeaking) {
    speechSynthesis.cancel();
    isSpeaking = false;
  }
  
  // User message
  const userWrapper = document.createElement("div");
  userWrapper.className = "message-wrapper user";
  userWrapper.innerHTML = `
    <div class="avatar">${getAvatar('user')}</div>
    <div>
      <div class="message">${selectedFile ? `üìé ${selectedFile.name}<br>${message}` : message}</div>
      ${settings.timestamps ? `<div class="timestamp">${getCurrentTime()}</div>` : ''}
    </div>
  `;
  messagesDiv.appendChild(userWrapper);
  
  if (!customMsg) inputEl.value = "";
  updateCharCounter();
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // Typing indicator
  const typing = document.createElement("div");
  typing.className = "message-wrapper bot";
  typing.innerHTML = `
    <div class="avatar">ü§ñ</div>
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  messagesDiv.appendChild(typing);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  try {
    let response;
    
    if (currentMode === 'image' && selectedFile) {
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('session_id', sessionId);
      formData.append('prompt', message);
      response = await fetch("/upload-image", { method: "POST", body: formData });
    } else if (currentMode === 'resume' && selectedFile) {
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('session_id', sessionId);
      formData.append('target_role', message || 'Software Engineer');
      response = await fetch("/analyze-resume", { method: "POST", body: formData });
    } else if (currentMode === 'quiz') {
      response = await fetch("/generate-quiz", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message, session_id: sessionId })
      });
    } else {
      response = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message, session_id: sessionId })
      });
    }
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || `Server error: ${response.status}`);
    }
    
    const data = await response.json();
    typing.remove();
    
    // Bot message
    const botWrapper = document.createElement("div");
    botWrapper.className = "message-wrapper bot";
    botWrapper.innerHTML = `
      <div class="avatar">ü§ñ</div>
      <div>
        <div class="message">
          ${formatMarkdown(data.response)}
          ${getMessageActions()}
        </div>
        ${settings.timestamps ? `<div class="timestamp">${getCurrentTime()}</div>` : ''}
      </div>
    `;
    messagesDiv.appendChild(botWrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    playSound('receive');
    saveToHistory(message, data.response);
    updateHistoryBadge();
    
  } catch (err) {
    typing.remove();
    const errWrapper = document.createElement("div");
    errWrapper.className = "message-wrapper bot";
    errWrapper.innerHTML = `
      <div class="avatar">‚ö†Ô∏è</div>
      <div>
        <div class="message">
          <strong>‚ö†Ô∏è Error:</strong> ${err.message}<br><br>
          <strong>Troubleshooting:</strong><br>
          ‚Üí Check if backend server is running (port 8000)<br>
          ‚Üí Verify OpenAI API key is set<br>
          ‚Üí Check your internet connection<br>
          ‚Üí Try refreshing the page<br><br>
          <em>Still having issues? Check browser console (F12) for details.</em>
          ${getMessageActions()}
        </div>
        ${settings.timestamps ? `<div class="timestamp">${getCurrentTime()}</div>` : ''}
      </div>
    `;
    messagesDiv.appendChild(errWrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    playSound('error');
    console.error('Chat error:', err);
  }
  
  clearFilePreview();
  sendBtn.disabled = false;
  sendBtn.textContent = 'Send ‚úàÔ∏è';
  inputEl.focus();
}

function copyMessage(btn) {
  const messageEl = btn.closest('.message');
  const text = messageEl.textContent.replace(/üìã CopyüîÑ Regenüîä Speak/g, '').trim();
  
  if (!text) {
    showToast('‚ö†Ô∏è Nothing to copy');
    return;
  }
  
  navigator.clipboard.writeText(text).then(() => {
    // Visual feedback on button
    const originalText = btn.textContent;
    btn.textContent = '‚úÖ Copied!';
    btn.style.background = 'var(--success)';
    btn.style.color = 'white';
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = 'rgba(139,92,246,0.1)';
      btn.style.color = 'var(--primary)';
    }, 1500);
    
    showToast('üìã Copied to clipboard');
    playSound('success');
  }).catch(() => {
    showToast('‚ùå Copy failed - try again');
    playSound('error');
  });
}

async function regenerateMessage(btn) {
  const botWrapper = btn.closest('.message-wrapper');
  const userWrapper = botWrapper.previousElementSibling;
  
  if (!userWrapper || !userWrapper.classList.contains('user')) {
    showToast('‚ùå Cannot regenerate - no previous message found');
    return;
  }
  
  // Stop any ongoing speech
  if (isSpeaking) {
    speechSynthesis.cancel();
    isSpeaking = false;
  }
  
  const userMsg = userWrapper.querySelector('.message');
  const userText = userMsg.textContent.replace(/üìé.+?\n/g, '').trim();
  
  // Disable button during regeneration
  btn.disabled = true;
  btn.textContent = '‚è≥ Regenerating...';
  
  // Remove the bot message
  botWrapper.remove();
  
  // Send message again
  await sendMessage(userText);
  
  showToast('üîÑ Message regenerated');
}

// Speech control
let currentSpeech = null;
let isSpeaking = false;

function speakMessage(btn) {
  if (!('speechSynthesis' in window)) {
    showToast('‚ùå Speech not supported');
    return;
  }

  // If already speaking, stop it
  if (isSpeaking) {
    speechSynthesis.cancel();
    isSpeaking = false;
    btn.textContent = 'üîä Speak';
    btn.style.background = 'rgba(139,92,246,0.1)';
    showToast('‚è∏Ô∏è Speech stopped');
    playSound('click');
    return;
  }

  const messageEl = btn.closest('.message');
  const text = messageEl.textContent.replace(/üìã CopyüîÑ Regenüîä Speak/g, '').trim();
  
  // Create utterance
  const utterance = new SpeechSynthesisUtterance(text);
  
  // Get best female voice
  const voices = speechSynthesis.getVoices();
  const femaleVoice = voices.find(voice => 
    (voice.name.includes('Female') || 
     voice.name.includes('Samantha') || 
     voice.name.includes('Victoria') ||
     voice.name.includes('Karen') ||
     voice.name.includes('Zira') ||
     voice.lang === 'en-US') && voice.gender === 'female'
  ) || voices.find(voice => voice.lang.startsWith('en'));
  
  if (femaleVoice) {
    utterance.voice = femaleVoice;
  }
  
  utterance.rate = 0.95;
  utterance.pitch = 1.1;
  utterance.volume = 0.9;
  
  // Event handlers
  utterance.onstart = () => {
    isSpeaking = true;
    btn.textContent = '‚è∏Ô∏è Stop';
    btn.style.background = 'var(--danger)';
    btn.style.color = 'white';
    showToast('üîä Speaking...');
  };
  
  utterance.onend = () => {
    isSpeaking = false;
    btn.textContent = 'üîä Speak';
    btn.style.background = 'rgba(139,92,246,0.1)';
    btn.style.color = 'var(--primary)';
  };
  
  utterance.onerror = () => {
    isSpeaking = false;
    btn.textContent = 'üîä Speak';
    btn.style.background = 'rgba(139,92,246,0.1)';
    btn.style.color = 'var(--primary)';
    showToast('‚ùå Speech failed');
  };
  
  currentSpeech = utterance;
  speechSynthesis.speak(utterance);
}

// Load voices when available
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => {
    // Voices loaded
  };
}

function clearChat() {
  if (confirm('‚ö†Ô∏è Clear all messages from this session?\n\nThis will not delete your saved history.')) {
    // Stop any ongoing speech
    if (isSpeaking) {
      speechSynthesis.cancel();
      isSpeaking = false;
    }
    
    const welcome = messagesDiv.firstElementChild;
    messagesDiv.innerHTML = '';
    messagesDiv.appendChild(welcome);
    showToast('üóëÔ∏è Chat cleared');
    playSound('click');
  }
}

// History
function saveToHistory(userMsg, botResponse) {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  history.unshift({
    id: Date.now(),
    title: userMsg.substring(0, 60),
    user: userMsg,
    bot: botResponse,
    timestamp: new Date().toISOString()
  });
  localStorage.setItem('chatHistory', JSON.stringify(history.slice(0, 50)));
}

function toggleHistory() {
  const modal = document.getElementById('historyModal');
  const isOpen = modal.classList.contains('active');
  
  if (isOpen) {
    modal.classList.remove('active');
  } else {
    loadHistory();
    modal.classList.add('active');
  }
}

function loadHistory() {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  const list = document.getElementById('historyList');
  
  if (history.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No History Yet</h3>
        <p>Your conversations will appear here</p>
      </div>
    `;
    return;
  }
  
  list.innerHTML = history.map(item => `
    <div class="history-item" data-id="${item.id}">
      <div class="history-item-title">${item.title}</div>
      <div class="history-item-meta">
        <span>${new Date(item.timestamp).toLocaleDateString()}</span>
        <button class="delete-btn" data-delete-id="${item.id}">Delete</button>
      </div>
    </div>
  `).join('');
  
  document.querySelectorAll('.history-item').forEach(item => {
    item.addEventListener('click', function(e) {
      if (!e.target.classList.contains('delete-btn')) {
        loadConversation(parseInt(this.getAttribute('data-id')));
      }
    });
  });
  
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteHistory(parseInt(this.getAttribute('data-delete-id')));
    });
  });
}

function loadConversation(id) {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  const item = history.find(h => h.id === id);
  if (!item) return;
  
  const welcome = messagesDiv.firstElementChild;
  messagesDiv.innerHTML = '';
  messagesDiv.appendChild(welcome);
  
  const userWrapper = document.createElement("div");
  userWrapper.className = "message-wrapper user";
  userWrapper.innerHTML = `
    <div class="avatar">üë§</div>
    <div>
      <div class="message">${item.user}</div>
      ${settings.timestamps ? `<div class="timestamp">${new Date(item.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>` : ''}
    </div>
  `;
  
  const botWrapper = document.createElement("div");
  botWrapper.className = "message-wrapper bot";
  botWrapper.innerHTML = `
    <div class="avatar">ü§ñ</div>
    <div>
      <div class="message">
        ${formatMarkdown(item.bot)}
        ${getMessageActions()}
      </div>
      ${settings.timestamps ? `<div class="timestamp">${new Date(item.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>` : ''}
    </div>
  `;
  
  messagesDiv.appendChild(userWrapper);
  messagesDiv.appendChild(botWrapper);
  
  toggleHistory();
  showToast('üìö Conversation loaded');
  playSound('success');
}

function deleteHistory(id) {
  if (!confirm('‚ö†Ô∏è Delete this conversation?\n\nThis action cannot be undone.')) {
    return;
  }
  
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  const filtered = history.filter(h => h.id !== id);
  localStorage.setItem('chatHistory', JSON.stringify(filtered));
  loadHistory();
  updateHistoryBadge();
  showToast('üóëÔ∏è Conversation deleted');
  playSound('click');
}

function updateHistoryBadge() {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  const badge = document.getElementById('historyBadge');
  if (history.length > 0) {
    badge.textContent = history.length;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

function exportChat() {
  const messages = Array.from(messagesDiv.querySelectorAll('.message-wrapper')).map(wrapper => {
    const role = wrapper.classList.contains('user') ? 'You' : 'AI Advisor';
    const message = wrapper.querySelector('.message').textContent.replace(/üìã CopyüîÑ Regenüîä Speak/g, '').trim();
    const timestamp = wrapper.querySelector('.timestamp')?.textContent || '';
    return `${role} [${timestamp}]:\n${message}\n`;
  }).join('\n---\n\n');
  
  if (!messages.trim()) {
    showToast('‚ö†Ô∏è No messages to export');
    return;
  }
  
  const header = `AI Student Advisor - Chat Export
Exported: ${new Date().toLocaleString()}
Session ID: ${sessionId}
Mode: ${currentMode}

========================================

`;
  
  const blob = new Blob([header + messages], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `AI_Student_Advisor_${new Date().toISOString().split('T')[0]}_${Date.now()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üíæ Chat exported successfully');
  playSound('success');
}

function clearAllData() {
  if (confirm('‚ö†Ô∏è DELETE ALL DATA?\n\nThis will permanently delete:\n‚Ä¢ All chat history\n‚Ä¢ All settings\n‚Ä¢ All saved data\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?')) {
    if (confirm('‚ö†Ô∏è FINAL WARNING\n\nClick OK to permanently delete everything.')) {
      // Stop any ongoing operations
      if (isSpeaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
      }
      if (isListening && recognition) {
        recognition.stop();
        isListening = false;
      }
      
      localStorage.clear();
      showToast('üóëÔ∏è All data cleared - Reloading...');
      
      setTimeout(() => {
        location.reload();
      }, 1500);
    }
  }
}

// Utilities
function showToast(msg) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function playSound(type) {
  if (!settings.sound) return;
  
  const sounds = {
    click: [200, 0.05],
    send: [400, 0.1],
    receive: [600, 0.1],
    success: [800, 0.15],
    error: [300, 0.2]
  };
  
  const [freq, duration] = sounds[type] || [400, 0.1];
  
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = freq;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  } catch (e) {
    // Silent fail for browsers without audio support
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>